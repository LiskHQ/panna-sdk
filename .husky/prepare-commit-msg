#!/bin/bash

# .husky/prepare-commit-msg

if ! command -v jq &> /dev/null; then
    echo "Warning: jq is required for AI commit message generation but is not installed" >&2
    exit 0
fi

# Load environment variables from .env file if it exists
if [ -f .env ]; then
    set -a
    source .env
    set +a
fi

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2

# Only generate for normal commits (not merges, squashes, etc.)
if [ -n "$COMMIT_SOURCE" ]; then
    exit 0
fi

# Get the staged diff
DIFF=$(git diff --cached --no-color)

# Skip if no changes staged
if [ -z "$DIFF" ]; then
    exit 0
fi

# Get list of changed files for context
FILES=$(git diff --cached --name-only)

# Truncate very large diffs to avoid token limits
MAX_CHARS=8000
if [ ${#DIFF} -gt $MAX_CHARS ]; then
    DIFF="${DIFF:0:$MAX_CHARS}... [truncated]"
fi

# Build the Commitizen-style prompt
read -r -d '' PROMPT << 'EOF'
Generate a Git commit message following the Commitizen conventional commit format.

FORMAT:
<type>(<scope>): <subject>

<body>

<footer>

TYPES (required):
- feat: A new feature
- fix: A bug fix
- docs: Documentation only changes
- style: Code style changes (formatting, semicolons, etc.)
- refactor: Code change that neither fixes a bug nor adds a feature
- perf: Performance improvement
- test: Adding or correcting tests
- build: Changes to build system or dependencies
- ci: Changes to CI configuration
- chore: Other changes that don't modify src or test files
- revert: Reverts a previous commit

RULES:
1. Type is required, scope is optional but encouraged
2. Subject: imperative mood, lowercase, no period, max 50 chars
3. Body: optional, wrap at 72 chars, explain what and why
4. Footer: optional, reference issues like "Closes #123"
5. Breaking changes: add "!" after type/scope and explain in footer

Output ONLY the commit message, no explanations or markdown.

EOF

if [ -z "$ANTHROPIC_API_KEY" ]; then
    echo "Warning: ANTHROPIC_API_KEY not set, skipping AI commit message generation" >&2
    exit 0
fi

PROMPT="$PROMPT

Changed files:
$FILES

Diff:
$DIFF"

# Call Claude API
RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
    -H "Content-Type: application/json" \
    -H "x-api-key: $ANTHROPIC_API_KEY" \
    -H "anthropic-version: 2023-06-01" \
    -d "$(jq -n \
        --arg prompt "$PROMPT" \
        '{
            model: "claude-sonnet-4-5-20250929",
            max_tokens: 512,
            messages: [{role: "user", content: $prompt}]
        }')")

# Extract the message text from the API response
MESSAGE=$(echo "$RESPONSE" | jq -r '.content[0].text // empty')

# Check if extraction succeeded
if [ -z "$MESSAGE" ]; then
    echo "Warning: Failed to generate commit message from Claude API" >&2
    # Check for error in RESPONSE
    ERROR=$(echo "$RESPONSE" | jq -r '.error.message // empty')
    if [ -n "$ERROR" ]; then
        echo "API Error: $ERROR" >&2
    fi
    exit 0
fi

if [ -n "$MESSAGE" ]; then
    # Write generated message, keep any existing content below
    echo "$MESSAGE" > "$COMMIT_MSG_FILE.tmp"
    echo "" >> "$COMMIT_MSG_FILE.tmp"
    echo "# --- Generated by Claude (Commitizen format) ---" >> "$COMMIT_MSG_FILE.tmp"
    echo "# Types: feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert" >> "$COMMIT_MSG_FILE.tmp"
    cat "$COMMIT_MSG_FILE" >> "$COMMIT_MSG_FILE.tmp"
    mv "$COMMIT_MSG_FILE.tmp" "$COMMIT_MSG_FILE"
fi